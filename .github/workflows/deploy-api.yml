name: Deploy API to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: prod-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Quick SSH ping
        uses: appleboy/ssh-action@v1.2.1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          timeout: 30s
          command_timeout: 2m
          fingerprint: ${{ secrets.DEPLOY_HOST_FINGERPRINT }}
          script: |
            set -e
            whoami
            uname -a

      - name: SSH deploy
        uses: appleboy/ssh-action@v1.2.1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          timeout: 30s
          command_timeout: 30m
          fingerprint: ${{ secrets.DEPLOY_HOST_FINGERPRINT }}
          script: |
            set -euo pipefail
            cd /opt/Big5-Quest

            # Git 更新
            git fetch --prune
            git reset --hard origin/main

            # --- env は root で読む → preserve して ec2-user に渡す ---
            sudo bash -lc '
              set -euo pipefail
              set -a
              source /etc/big5quest.env
              set +a

              sudo --preserve-env=RAILS_ENV,SECRET_KEY_BASE,DB_HOST,DB_PORT,DB_NAME,DB_USERNAME,DB_PASSWORD,SENTRY_DSN,SENTRY_ENV \
                -u ec2-user bash -lc "
                  set -euo pipefail
                  export RBENV_ROOT=\$HOME/.rbenv
                  export PATH=\$RBENV_ROOT/bin:\$RBENV_ROOT/shims:\$PATH
                  if command -v rbenv >/dev/null 2>&1; then eval \\"$(rbenv init - bash)\\"; fi

                  cd /opt/Big5-Quest
                  export RAILS_ENV=production

                  echo ruby: \$(ruby -v || true)
                  echo bundle: \$(bundle -v || true)

                  bundle config set without \\"development test\\"
                  bundle config set path \\"vendor/bundle\\"
                  bundle install --no-cache --jobs 3

                  bin/rails db:migrate --trace
                "
            '

            # 再起動 & 状態確認 & ヘルスチェック
            sudo systemctl restart big5quest
            sleep 1
            echo "== systemd status =="
            sudo systemctl status --no-pager big5quest || true
            echo "== last 50 logs =="
            sudo journalctl -u big5quest --no-pager -n 50 || true

            tries=30; ok=0
            for i in $(seq 1 $tries); do
              if curl -fsS -H "Host: api.big5-quest.com" -H "X-Forwarded-Proto: https" http://127.0.0.1:80/up >/dev/null; then
                echo "Health OK"; ok=1; break
              fi
              echo "Waiting app to boot... ($i/$tries)"
              sleep 2
            done
            if [ "$ok" -ne 1 ]; then
              echo "::error::Healthcheck failed. Dumping last 200 logs..."
              sudo journalctl -u big5quest --no-pager -n 200 || true
              sudo systemctl cat big5quest || true
              exit 1
            fi