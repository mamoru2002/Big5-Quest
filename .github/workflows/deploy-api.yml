name: Deploy API to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: prod-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Quick SSH ping
        uses: appleboy/ssh-action@v1.2.1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          timeout: 30s
          command_timeout: 2m
          fingerprint: ${{ secrets.DEPLOY_HOST_FINGERPRINT }}
          script: |
            set -e
            whoami
            uname -a

      - name: SSH deploy
        uses: appleboy/ssh-action@v1.2.1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          timeout: 30s
          command_timeout: 30m
          fingerprint: ${{ secrets.DEPLOY_HOST_FINGERPRINT }}
          script: |
            set -euo pipefail

            cd /opt/Big5-Quest

            # Git 更新
            git fetch --prune
            git reset --hard origin/main

            # アプリ環境変数を読み込み（/etc/big5quest.env に本番変数がある前提）
            # 以降のコマンドは ec2-user で同一ユーザー実行
            sudo -u ec2-user bash -lc '
              set -euo pipefail
              set -a
              [ -f /etc/big5quest.env ] && source /etc/big5quest.env
              set +a

              cd /opt/Big5-Quest

              # Bundler
              export RAILS_ENV=production
              bundle config set without "development test"
              bundle config set path "vendor/bundle"
              bundle install --no-cache --jobs 3

              # DB マイグレーション
              bin/rails db:migrate
            '

            # 再起動
            sudo systemctl restart big5quest

            # ヘルスチェック（最大 ~60秒）
            tries=30
            ok=0
            for i in $(seq 1 $tries); do
              if curl -fsS -H "Host: api.big5-quest.com" -H "X-Forwarded-Proto: https" \
                   http://127.0.0.1:80/up >/dev/null; then
                echo "Health OK"
                ok=1
                break
              fi
              echo "Waiting app to boot... ($i/$tries)"
              sleep 2
            done

            if [ "$ok" -ne 1 ]; then
              echo "::error::Healthcheck failed. Dumping last logs..."
              sudo journalctl -u big5quest --no-pager -n 200 || true
              exit 1
            fi